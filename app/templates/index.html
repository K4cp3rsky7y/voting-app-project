<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>{{ title }}</h1>
            <p class="subtitle">Kt√≥ry klub jest lepszy? Real Madrid czy FC Barcelona?</p>
        </header>

        <main>
            <div class="voting-section">
                <h2>Wybierz swojƒÖ opcjƒô:</h2>
                <div class="vote-buttons">
                    <button class="vote-btn vote-btn-1" onclick="vote('{{ option1 }}')">
                        <img src="{{ url_for('static', filename='images/real-madrid-logo.png') }}" alt="Real Madrid" class="team-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <span class="vote-icon" style="display:none;">‚ö™</span>
                        <span class="vote-text">{{ option1 }}</span>
                    </button>
                    <button class="vote-btn vote-btn-2" onclick="vote('{{ option2 }}')">
                        <img src="{{ url_for('static', filename='images/barcelona-logo.png') }}" alt="FC Barcelona" class="team-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <span class="vote-icon" style="display:none;">üîµüî¥</span>
                        <span class="vote-text">{{ option2 }}</span>
                    </button>
                </div>
            </div>

            <div class="results-section">
                <h2>Wyniki g≈Çosowania</h2>
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-label">
                            <img src="{{ url_for('static', filename='images/real-madrid-logo.png') }}" alt="Real Madrid" class="stat-logo" onerror="this.style.display='none';">
                            <span>{{ option1 }}</span>
                        </div>
                        <div class="stat-value" id="vote1">{{ vote1 }}</div>
                        <div class="stat-bar">
                            <div class="stat-bar-fill" id="bar1" style="width: {{ (vote1 / total * 100) if total > 0 else 0 }}%"></div>
                        </div>
                        <div class="stat-percentage" id="perc1">{{ "%.1f"|format((vote1 / total * 100) if total > 0 else 0) }}%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">
                            <img src="{{ url_for('static', filename='images/barcelona-logo.png') }}" alt="FC Barcelona" class="stat-logo" onerror="this.style.display='none';">
                            <span>{{ option2 }}</span>
                        </div>
                        <div class="stat-value" id="vote2">{{ vote2 }}</div>
                        <div class="stat-bar">
                            <div class="stat-bar-fill" id="bar2" style="width: {{ (vote2 / total * 100) if total > 0 else 0 }}%"></div>
                        </div>
                        <div class="stat-percentage" id="perc2">{{ "%.1f"|format((vote2 / total * 100) if total > 0 else 0) }}%</div>
                    </div>
                </div>
                <div class="total-votes">
                    <strong>≈ÅƒÖczna liczba g≈Ços√≥w: <span id="total">{{ total }}</span></strong>
                </div>
            </div>

            <div class="extra-sections">
                <section class="recent-votes-section">
                    <h2>Ostatnie g≈Çosy</h2>
                    <p class="section-desc">Na ≈ºywo pokazujemy ostatnie oddane g≈Çosy.</p>
                    <ul id="recent-votes-list" class="recent-votes-list">
                        {% for vote in recent_votes %}
                            <li class="recent-vote-item">
                                <span class="recent-vote-team">
                                    {{ vote.option }}
                                </span>
                                <span class="recent-vote-meta">
                                    {{ vote.timestamp.split('T')[0] }} {{ vote.timestamp.split('T')[1][:8] }}
                                </span>
                            </li>
                        {% else %}
                            <li class="recent-vote-empty">Brak g≈Ços√≥w ‚Äì bƒÖd≈∫ pierwszym kibicem!</li>
                        {% endfor %}
                    </ul>
                </section>

                <section class="fan-wall-section">
                    <h2>≈öciana kibica</h2>
                    <p class="section-desc">Zostaw kr√≥tkƒÖ wiadomo≈õƒá, komu kibicujesz i dlaczego.</p>

                    <form id="fan-form" class="fan-form" onsubmit="submitFanMessage(event)">
                        <div class="fan-form-row">
                            <input type="text" name="name" placeholder="Twoje imiƒô (opcjonalnie)">
                            <select name="team">
                                <option value="{{ option1 }}">{{ option1 }}</option>
                                <option value="{{ option2 }}">{{ option2 }}</option>
                            </select>
                        </div>
                        <textarea name="message" rows="3" maxlength="200" placeholder="Twoja wiadomo≈õƒá (max 200 znak√≥w)" required></textarea>
                        <button type="submit" class="fan-submit-btn">Wy≈õlij wiadomo≈õƒá</button>
                    </form>

                    <ul id="fan-messages-list" class="fan-messages-list">
                        {% for msg in fan_messages %}
                            <li class="fan-message-item">
                                <div class="fan-message-header">
                                    <span class="fan-message-name">{{ msg.name or 'Anonim' }}</span>
                                    <span class="fan-message-team">{{ msg.team }}</span>
                                </div>
                                <div class="fan-message-body">
                                    {{ msg.message }}
                                </div>
                            </li>
                        {% else %}
                            <li class="fan-message-empty">Napisz pierwszƒÖ wiadomo≈õƒá na ≈õcianie kibica!</li>
                        {% endfor %}
                    </ul>
                </section>
            </div>

            <div class="actions-section">
                <button class="reset-btn" onclick="resetVotes()">Resetuj g≈Çosy</button>
                <button class="refresh-btn" onclick="refreshStats()">Od≈õwie≈º statystyki</button>
            </div>
        </main>

        <footer>
            <p>Technologie: Flask | Redis | RabbitMQ | Docker</p>
        </footer>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function vote(option) {
            const formData = new FormData();
            formData.append('vote', option);

            fetch('/vote', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateStats(data);
                    showNotification(`Dziƒôkujemy za g≈Ços na ${option}!`, 'success');
                } else {
                    showNotification('WystƒÖpi≈Ç b≈ÇƒÖd podczas g≈Çosowania', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('WystƒÖpi≈Ç b≈ÇƒÖd po≈ÇƒÖczenia', 'error');
            });
        }

        function resetVotes() {
            if (!confirm('Czy na pewno chcesz zresetowaƒá wszystkie g≈Çosy?')) {
                return;
            }

            fetch('/reset', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    refreshStats();
                    showNotification('G≈Çosy zosta≈Çy zresetowane', 'success');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('WystƒÖpi≈Ç b≈ÇƒÖd podczas resetowania', 'error');
            });
        }

        function refreshStats() {
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => {
                    updateStats(data);
                    loadRecentVotes();
                    loadFanMessages();
                    showNotification('Statystyki zaktualizowane', 'success');
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('WystƒÖpi≈Ç b≈ÇƒÖd podczas od≈õwie≈ºania', 'error');
                });
        }

        function updateStats(data) {
            document.getElementById('vote1').textContent = data.vote1;
            document.getElementById('vote2').textContent = data.vote2;
            document.getElementById('total').textContent = data.total;
            
            const total = data.total || 1;
            const perc1 = ((data.vote1 / total) * 100).toFixed(1);
            const perc2 = ((data.vote2 / total) * 100).toFixed(1);
            
            document.getElementById('bar1').style.width = perc1 + '%';
            document.getElementById('bar2').style.width = perc2 + '%';
            document.getElementById('perc1').textContent = perc1 + '%';
            document.getElementById('perc2').textContent = perc2 + '%';
        }

        function loadRecentVotes() {
            fetch('/api/recent_votes')
                .then(response => response.json())
                .then(votes => {
                    const list = document.getElementById('recent-votes-list');
                    list.innerHTML = '';

                    if (!votes.length) {
                        const li = document.createElement('li');
                        li.className = 'recent-vote-empty';
                        li.textContent = 'Brak g≈Ços√≥w ‚Äì bƒÖd≈∫ pierwszym kibicem!';
                        list.appendChild(li);
                        return;
                    }

                    votes.forEach(vote => {
                        const li = document.createElement('li');
                        li.className = 'recent-vote-item';

                        const teamSpan = document.createElement('span');
                        teamSpan.className = 'recent-vote-team';
                        teamSpan.textContent = vote.option;

                        const metaSpan = document.createElement('span');
                        metaSpan.className = 'recent-vote-meta';
                        if (vote.timestamp) {
                            const [date, time] = vote.timestamp.split('T');
                            metaSpan.textContent = `${date} ${time.slice(0, 8)}`;
                        } else {
                            metaSpan.textContent = '';
                        }

                        li.appendChild(teamSpan);
                        li.appendChild(metaSpan);
                        list.appendChild(li);
                    });
                })
                .catch(err => console.error('recent_votes error', err));
        }

        function loadFanMessages() {
            fetch('/api/fan_messages')
                .then(response => response.json())
                .then(messages => {
                    const list = document.getElementById('fan-messages-list');
                    list.innerHTML = '';

                    if (!messages.length) {
                        const li = document.createElement('li');
                        li.className = 'fan-message-empty';
                        li.textContent = 'Napisz pierwszƒÖ wiadomo≈õƒá na ≈õcianie kibica!';
                        list.appendChild(li);
                        return;
                    }

                    messages.forEach(msg => {
                        const li = document.createElement('li');
                        li.className = 'fan-message-item';

                        const header = document.createElement('div');
                        header.className = 'fan-message-header';

                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'fan-message-name';
                        nameSpan.textContent = msg.name || 'Anonim';

                        const teamSpan = document.createElement('span');
                        teamSpan.className = 'fan-message-team';
                        teamSpan.textContent = msg.team;

                        header.appendChild(nameSpan);
                        header.appendChild(teamSpan);

                        const body = document.createElement('div');
                        body.className = 'fan-message-body';
                        body.textContent = msg.message;

                        li.appendChild(header);
                        li.appendChild(body);
                        list.appendChild(li);
                    });
                })
                .catch(err => console.error('fan_messages error', err));
        }

        function submitFanMessage(event) {
            event.preventDefault();
            const form = document.getElementById('fan-form');
            const formData = new FormData(form);

            fetch('/fan-message', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Wiadomo≈õƒá zosta≈Ça dodana na ≈õcianƒô kibica!', 'success');
                        form.reset();
                        loadFanMessages();
                    } else {
                        showNotification(data.error || 'Nie uda≈Ço siƒô dodaƒá wiadomo≈õci', 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('WystƒÖpi≈Ç b≈ÇƒÖd podczas wysy≈Çania wiadomo≈õci', 'error');
                });
        }

        // Auto-refresh co 5 sekund
        refreshStats();
        setInterval(refreshStats, 5000);
    </script>
</body>
</html>
